<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            margin: 0;
            padding: 20px;
            background-color: #f5f5f5;
        }
        
        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: #007AFF;
            color: white;
            padding: 20px;
            text-align: center;
        }
        
        .login-section {
            padding: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .login-section input {
            width: 200px;
            padding: 10px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .login-section button {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .status {
            padding: 10px 20px;
            background: #f8f9fa;
            border-bottom: 1px solid #eee;
            font-size: 14px;
        }
        
        .status.connected {
            background: #d4edda;
            color: #155724;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
        }
        
        .chat-section {
            display: none;
            padding: 20px;
        }
        
        .room-controls {
            margin-bottom: 20px;
        }
        
        .room-controls input {
            width: 100px;
            padding: 8px;
            margin-right: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .room-controls button {
            padding: 8px 15px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .chat-window {
            height: 400px;
            border: 1px solid #ddd;
            border-radius: 5px;
            overflow-y: auto;
            padding: 15px;
            background: #fafafa;
            margin-bottom: 15px;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 10px;
            border-radius: 10px;
            max-width: 70%;
        }
        
        .message.own {
            background: #007AFF;
            color: white;
            margin-left: auto;
            text-align: right;
        }
        
        .message.other {
            background: white;
            border: 1px solid #ddd;
        }
        
        .message-info {
            font-size: 12px;
            opacity: 0.7;
            margin-bottom: 5px;
        }
        
        .message-content {
            word-wrap: break-word;
        }
        
        .message-input {
            display: flex;
            gap: 10px;
        }
        
        .message-input input {
            flex: 1;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
        }
        
        .message-input button {
            padding: 10px 20px;
            background: #007AFF;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
        
        .typing-indicator {
            font-style: italic;
            color: #666;
            font-size: 14px;
            margin: 10px 0;
        }
        
        .online-users {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸš€ ì‹¤ì‹œê°„ ì±„íŒ… í…ŒìŠ¤íŠ¸</h1>
            <p>Socket.IO + JWT ì¸ì¦ + ë°ì´í„°ë² ì´ìŠ¤ ì—°ë™</p>
        </div>
        
        <div class="login-section">
            <h3>ë¡œê·¸ì¸</h3>
            <input type="text" id="username" placeholder="ì‚¬ìš©ìëª…" value="testuser">
            <input type="password" id="password" placeholder="ë¹„ë°€ë²ˆí˜¸" value="test123">
            <button onclick="login()">ë¡œê·¸ì¸</button>
            <button onclick="register()">íšŒì›ê°€ì…</button>
        </div>
        
        <div class="status" id="status">ì—°ê²°ë˜ì§€ ì•ŠìŒ</div>
        
        <div class="chat-section" id="chatSection">
            <div class="room-controls">
                <h3>ì±„íŒ…ë°© ì…ì¥</h3>
                <input type="number" id="roomId" placeholder="ë°© ID" value="1">
                <button onclick="joinRoom()">ë°© ì…ì¥</button>
                <button onclick="createDirectChat()">1:1 ì±„íŒ… ì‹œì‘</button>
            </div>
            
            <div class="online-users" id="onlineUsers"></div>
            <div class="typing-indicator" id="typingIndicator"></div>
            
            <div class="chat-window" id="chatWindow"></div>
            
            <div class="message-input">
                <input type="text" id="messageInput" placeholder="ë©”ì‹œì§€ë¥¼ ì…ë ¥í•˜ì„¸ìš”..." 
                       onkeypress="handleKeyPress(event)" 
                       oninput="handleTyping()"
                       onblur="stopTyping()">
                <button onclick="sendMessage()">ì „ì†¡</button>
            </div>
        </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
        let socket;
        let currentUser = null;
        let currentRoom = null;
        let typingTimer;
        
        // ì„œë²„ ì—°ê²°
        function connectSocket() {
            socket = io();
            
            socket.on('connect', () => {
                updateStatus('ì„œë²„ì— ì—°ê²°ë˜ì—ˆìŠµë‹ˆë‹¤', 'connected');
            });
            
            socket.on('disconnect', () => {
                updateStatus('ì„œë²„ ì—°ê²°ì´ ëŠì–´ì¡ŒìŠµë‹ˆë‹¤', 'error');
            });
            
            // ì¸ì¦ ì‘ë‹µ
            socket.on('authenticated', (data) => {
                currentUser = data.user;
                updateStatus(`${data.user.username}ë‹˜ìœ¼ë¡œ ë¡œê·¸ì¸ë¨`, 'connected');
                document.getElementById('chatSection').style.display = 'block';
            });
            
            socket.on('auth-error', (data) => {
                updateStatus(`ì¸ì¦ ì‹¤íŒ¨: ${data.message}`, 'error');
            });
            
            // ì±„íŒ…ë°© ì…ì¥
            socket.on('room-joined', (data) => {
                currentRoom = data.roomId;
                updateStatus(`ë°© ${data.roomId}ì— ì…ì¥í–ˆìŠµë‹ˆë‹¤`, 'connected');
                
                // ê¸°ì¡´ ë©”ì‹œì§€ í‘œì‹œ
                const chatWindow = document.getElementById('chatWindow');
                chatWindow.innerHTML = '';
                
                data.messages.forEach(msg => {
                    displayMessage(msg);
                });
                
                scrollToBottom();
            });
            
            // ì‹¤ì‹œê°„ ë©”ì‹œì§€ ìˆ˜ì‹ 
            socket.on('receive-message', (message) => {
                displayMessage(message);
                scrollToBottom();
            });
            
            // ì‚¬ìš©ì ì…ì¥/í‡´ì¥
            socket.on('user-joined-room', (data) => {
                showSystemMessage(`${data.username}ë‹˜ì´ ì…ì¥í–ˆìŠµë‹ˆë‹¤`);
            });
            
            socket.on('user-left-room', (data) => {
                showSystemMessage(`${data.username}ë‹˜ì´ í‡´ì¥í–ˆìŠµë‹ˆë‹¤`);
            });
            
            // íƒ€ì´í•‘ ìƒíƒœ
            socket.on('user-typing', (data) => {
                if (data.isTyping) {
                    document.getElementById('typingIndicator').textContent = 
                        `${data.username}ë‹˜ì´ ì…ë ¥ ì¤‘...`;
                } else {
                    document.getElementById('typingIndicator').textContent = '';
                }
            });
            
            // ì˜¨ë¼ì¸ ì‚¬ìš©ì
            socket.on('online-users', (data) => {
                document.getElementById('onlineUsers').textContent = 
                    `ì˜¨ë¼ì¸: ${data.users.map(u => u.username).join(', ')} (${data.count}ëª…)`;
            });
            
            // ì—ëŸ¬ ì²˜ë¦¬
            socket.on('error', (data) => {
                updateStatus(`ì˜¤ë¥˜: ${data.message}`, 'error');
            });
        }
        
        // ë¡œê·¸ì¸
        async function login() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // í† í° ì €ì¥
                    localStorage.setItem('token', data.data.token);
                    
                    // Socket.IO ì¸ì¦
                    if (!socket) connectSocket();
                    socket.emit('authenticate', { token: data.data.token });
                } else {
                    updateStatus(`ë¡œê·¸ì¸ ì‹¤íŒ¨: ${data.message}`, 'error');
                }
            } catch (error) {
                updateStatus(`ë¡œê·¸ì¸ ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // íšŒì›ê°€ì…
        async function register() {
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const email = `${username}@test.com`;
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username, email, password })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    updateStatus('íšŒì›ê°€ì… ì„±ê³µ! ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'connected');
                } else {
                    updateStatus(`íšŒì›ê°€ì… ì‹¤íŒ¨: ${data.message}`, 'error');
                }
            } catch (error) {
                updateStatus(`íšŒì›ê°€ì… ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ì±„íŒ…ë°© ì…ì¥
        function joinRoom() {
            const roomId = document.getElementById('roomId').value;
            if (socket && roomId) {
                socket.emit('join-room', { roomId: parseInt(roomId) });
            }
        }
        
        // 1:1 ì±„íŒ… ì‹œì‘
        async function createDirectChat() {
            const targetUserId = prompt('ì±„íŒ…í•  ìƒëŒ€ë°© IDë¥¼ ì…ë ¥í•˜ì„¸ìš”:');
            if (!targetUserId) return;
            
            const token = localStorage.getItem('token');
            if (!token) {
                updateStatus('ë¨¼ì € ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            try {
                const response = await fetch(`/api/chat/direct/${targetUserId}`, {
                    method: 'POST',
                    headers: { 
                        'Authorization': `Bearer ${token}`
                    }
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('roomId').value = data.data.room.id;
                    joinRoom();
                } else {
                    updateStatus(`1:1 ì±„íŒ… ìƒì„± ì‹¤íŒ¨: ${data.message}`, 'error');
                }
            } catch (error) {
                updateStatus(`1:1 ì±„íŒ… ì˜¤ë¥˜: ${error.message}`, 'error');
            }
        }
        
        // ë©”ì‹œì§€ ì „ì†¡
        function sendMessage() {
            const input = document.getElementById('messageInput');
            const message = input.value.trim();
            
            if (socket && currentRoom && message) {
                socket.emit('send-message', {
                    roomId: currentRoom,
                    message: message
                });
                input.value = '';
                stopTyping();
            }
        }
        
        // ë©”ì‹œì§€ í‘œì‹œ
        function displayMessage(msg) {
            const chatWindow = document.getElementById('chatWindow');
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${msg.user.id === currentUser?.id ? 'own' : 'other'}`;
            
            const time = new Date(msg.created_at).toLocaleTimeString();
            
            messageDiv.innerHTML = `
                <div class="message-info">${msg.user.username} - ${time}</div>
                <div class="message-content">${msg.message}</div>
            `;
            
            chatWindow.appendChild(messageDiv);
        }
        
        // ì‹œìŠ¤í…œ ë©”ì‹œì§€ í‘œì‹œ
        function showSystemMessage(text) {
            const chatWindow = document.getElementById('chatWindow');
            const messageDiv = document.createElement('div');
            messageDiv.style.textAlign = 'center';
            messageDiv.style.color = '#666';
            messageDiv.style.fontSize = '14px';
            messageDiv.style.margin = '10px 0';
            messageDiv.textContent = text;
            chatWindow.appendChild(messageDiv);
            scrollToBottom();
        }
        
        // ìŠ¤í¬ë¡¤ í•˜ë‹¨ìœ¼ë¡œ
        function scrollToBottom() {
            const chatWindow = document.getElementById('chatWindow');
            chatWindow.scrollTop = chatWindow.scrollHeight;
        }
        
        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(message, type = '') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }
        
        // í‚¤ë³´ë“œ ì´ë²¤íŠ¸
        function handleKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }
        
        // íƒ€ì´í•‘ ìƒíƒœ
        function handleTyping() {
            if (socket && currentRoom) {
                socket.emit('typing-start', { roomId: currentRoom });
                
                clearTimeout(typingTimer);
                typingTimer = setTimeout(() => {
                    stopTyping();
                }, 1000);
            }
        }
        
        function stopTyping() {
            if (socket && currentRoom) {
                socket.emit('typing-stop', { roomId: currentRoom });
            }
            clearTimeout(typingTimer);
        }
        
        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì†Œì¼“ ì—°ê²°
        window.addEventListener('load', () => {
            updateStatus('ì„œë²„ì— ì—°ê²° ì¤‘...', '');
        });
    </script>
</body>
</html>